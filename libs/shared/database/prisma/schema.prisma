generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER DOMAIN
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  fullName       String    @map("full_name")
  email          String?   @unique
  phone          String?   @unique
  dateOfBirth    DateTime  @map("date_of_birth")
  role           UserRole  @default(CUSTOMER)
  kycStatus      KYCStatus @default(PENDING) @map("kyc_status")
  isActive       Boolean   @default(true) @map("is_active")
  isDeleted      Boolean   @default(false) @map("is_deleted")
  passwordHash   String?   @map("password_hash")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  walletBalance  Decimal   @default(0) @map("wallet_balance") @db.Decimal(10, 2)
  walletCurrency String    @default("USD") @map("wallet_currency") @db.VarChar(3)

  authProviders       AuthProviderLink[]
  refreshToken        RefreshToken[]
  loginActivities     LoginActivity[]
  passwordResetTokens PasswordResetToken[]
  inventoryItems      InventoryItem[]
  transactions        Transaction[]
  shippingAddresses   ShippingAddress[]
  shipments           Shipment[]
  sellerTrades        Trade[]            @relation("SellerTrades")
  buyerTrades         Trade[]            @relation("BuyerTrades")
  auctions            Auction[]
  bids                Bid[]
  mediaFiles          MediaFile[]

  @@map("users")
}

// ============================================
// AUTHENTICATION DOMAIN
// ============================================

enum AuthProvider {
  GOOGLE
  APPLE
  PHONE
  EMAIL
}

model AuthProviderLink {
  id         String       @id @default(uuid()) @db.Uuid
  userID     String       @map("user_id") @db.Uuid
  provider   AuthProvider
  providerID String       @map("provider_id")
  createdAt  DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@unique([provider, providerID])
  @@map("auth_provider_links")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userID    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@index([userID])
  @@index([token])
  @@map("refresh_tokens")
}

model LoginActivity {
  id            String       @id @default(uuid()) @db.Uuid
  userID        String       @map("user_id") @db.Uuid
  loginAt       DateTime     @default(now()) @map("login_at") @db.Timestamptz(6)
  ipAddress     String?      @map("ip_address") @db.VarChar(45)
  userAgent     String?      @map("user_agent") @db.VarChar(500)
  deviceType    String?      @map("device_type") @db.VarChar(50)
  platform      String?      @db.VarChar(50)
  browser       String?      @db.VarChar(50)
  loginMethod   AuthProvider @map("login_method")
  success       Boolean      @default(false)
  failureReason String?      @map("failure_reason") @db.VarChar(255)

  user User @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@index([userID])
  @@index([userID, loginAt])
  @@index([loginAt])
  @@map("login_activities")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userID    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@index([userID])
  @@index([token])
  @@map("password_reset_tokens")
}

// ============================================
// TRANSACTION DOMAIN
// ============================================

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PACK_PURCHASE
  TRADE_SALE
  TRADE_PURCHASE
  AUCTION_SALE
  AUCTION_PURCHASE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Transaction {
  id              String            @id @default(uuid()) @db.Uuid
  userID          String            @map("user_id") @db.Uuid
  type            TransactionType
  amount          Decimal           @db.Decimal(10, 2)
  fee             Decimal           @default(0) @db.Decimal(10, 2)
  netAmount       Decimal           @map("net_amount") @db.Decimal(10, 2) // amount - fee
  status          TransactionStatus @default(PENDING)
  referenceID     String?           @map("reference_id") @db.Uuid // Links to Trade, Auction, etc.
  referenceType   String?           @map("reference_type") @db.VarChar(50) // 'trade', 'auction', etc.
  paymentMethod   String?           @map("payment_method") @db.VarChar(100)
  metadata        String?           @db.Text // JSON field for additional data
  createdAt       DateTime          @default(now()) @map("created_at")
  completedAt     DateTime?         @map("completed_at")

  user User @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@index([userID])
  @@index([createdAt])
  @@index([status])
  @@index([referenceID, referenceType])
  @@map("transactions")
}

// ============================================
// INVENTORY DOMAIN
// ============================================

enum PackType {
  DRAFT
  PRO
  ALL_STARS
  HALL_OF_FAME
  LEGENDS
}

enum SportType {
  FOOTBALL
  BASEBALL
  BASKETBALL
  MULTISPORT
}

enum CardRarity {
  GRAIL
  CHASE
  LINEUP
}

enum CardLocation {
  VAULT
  PENDING_SHIP
  SHIPPED
}

enum CardCondition {
  MINT
  NEAR_MINT
}

model Pack {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  packType    PackType  @map("pack_type")
  sportType   SportType @map("sport_type")
  imageUrl    String?   @map("image_url") @db.VarChar(500)
  bannerUrl   String?   @map("banner_url") @db.VarChar(500)
  description String?   @db.Text
  price       Decimal?  @db.Decimal(10, 2)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  cards Card[]

  @@index([packType])
  @@index([sportType])
  @@index([isActive])
  @@map("packs")
}

model Card {
  id             String     @id @default(uuid()) @db.Uuid
  packID         String     @map("pack_id") @db.Uuid
  name           String
  sportType      SportType  @map("sport_type")
  rarity         CardRarity
  imageUrl       String?    @map("image_url") @db.VarChar(500)
  bannerUrl      String?    @map("banner_url") @db.VarChar(500)
  estimatedValue Decimal?   @map("estimated_value") @db.Decimal(10, 2)
  serialNumber   String?    @unique @map("serial_number") @db.VarChar(50)
  description    String?    @db.Text
  playerName     String?    @map("player_name")
  year           Int?
  manufacturer   String?    @db.VarChar(100)
  condition      CardCondition?
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  pack           Pack            @relation(fields: [packID], references: [id], onDelete: Restrict)
  inventoryItems InventoryItem[]

  @@index([packID])
  @@index([sportType])
  @@index([rarity])
  @@index([serialNumber])
  @@map("cards")
}

model InventoryItem {
  id           String       @id @default(uuid()) @db.Uuid
  userID       String       @map("user_id") @db.Uuid
  cardID       String       @map("card_id") @db.Uuid
  location     CardLocation @default(VAULT)
  acquiredAt   DateTime     @default(now()) @map("acquired_at")
  shippedAt    DateTime?    @map("shipped_at")

  user      User       @relation(fields: [userID], references: [id], onDelete: Cascade)
  card      Card       @relation(fields: [cardID], references: [id], onDelete: Restrict)
  trades    Trade[]
  auctions  Auction[]
  shipments Shipment[]

  @@index([userID])
  @@index([cardID])
  @@index([location])
  @@index([userID, location])
  @@map("inventory_items")
}

// ============================================
// TRADING DOMAIN
// ============================================

enum TradeType {
  FIXED_PRICE
  CARD_HIVE_BUYBACK // Trade back to Card Hive
}

enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  CANCELLED
}

model Trade {
  id              String      @id @default(uuid()) @db.Uuid
  inventoryItemID String      @map("inventory_item_id") @db.Uuid
  sellerID        String      @map("seller_id") @db.Uuid
  buyerID         String?     @map("buyer_id") @db.Uuid // Null for CARD_HIVE_BUYBACK
  type            TradeType
  price           Decimal     @db.Decimal(10, 2)
  status          TradeStatus @default(PENDING)
  notes           String?     @db.Text
  createdAt       DateTime    @default(now()) @map("created_at")
  acceptedAt      DateTime?   @map("accepted_at")
  completedAt     DateTime?   @map("completed_at")
  cancelledAt     DateTime?   @map("cancelled_at")

  inventoryItem InventoryItem @relation(fields: [inventoryItemID], references: [id], onDelete: Restrict)
  seller        User          @relation("SellerTrades", fields: [sellerID], references: [id], onDelete: Cascade)
  buyer         User?         @relation("BuyerTrades", fields: [buyerID], references: [id], onDelete: Cascade)

  @@index([sellerID])
  @@index([buyerID])
  @@index([inventoryItemID])
  @@index([status])
  @@index([type])
  @@map("trades")
}

// ============================================
// AUCTION DOMAIN
// ============================================

enum AuctionStatus {
  ACTIVE
  ENDED
  CANCELLED
}

model Auction {
  id              String        @id @default(uuid()) @db.Uuid
  inventoryItemID String        @map("inventory_item_id") @db.Uuid
  sellerID        String        @map("seller_id") @db.Uuid
  startingPrice   Decimal       @map("starting_price") @db.Decimal(10, 2)
  reservePrice    Decimal?      @map("reserve_price") @db.Decimal(10, 2) // Minimum acceptable price
  currentPrice    Decimal       @map("current_price") @db.Decimal(10, 2)
  winningBidID    String?       @unique @map("winning_bid_id") @db.Uuid
  status          AuctionStatus @default(ACTIVE)
  startTime       DateTime      @map("start_time")
  endTime         DateTime      @map("end_time")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  inventoryItem InventoryItem @relation(fields: [inventoryItemID], references: [id], onDelete: Restrict)
  seller        User          @relation(fields: [sellerID], references: [id], onDelete: Cascade)
  bids          Bid[]
  winningBid    Bid?          @relation("WinningBid", fields: [winningBidID], references: [id], onDelete: SetNull)

  @@index([sellerID])
  @@index([inventoryItemID])
  @@index([status])
  @@index([endTime])
  @@map("auctions")
}

enum BidStatus {
  ACTIVE
  OUTBID
  WON
  LOST
}

model Bid {
  id        String    @id @default(uuid()) @db.Uuid
  auctionID String    @map("auction_id") @db.Uuid
  bidderID  String    @map("bidder_id") @db.Uuid
  amount    Decimal   @db.Decimal(10, 2)
  status    BidStatus @default(ACTIVE)
  createdAt DateTime  @default(now()) @map("created_at")

  auction       Auction  @relation(fields: [auctionID], references: [id], onDelete: Cascade)
  bidder        User     @relation(fields: [bidderID], references: [id], onDelete: Cascade)
  wonAuction    Auction? @relation("WinningBid")

  @@index([auctionID])
  @@index([bidderID])
  @@index([status])
  @@index([createdAt])
  @@map("bids")
}

// ============================================
// SHIPPING DOMAIN
// ============================================

enum ShippingStatus {
  PENDING
  PROCESSING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

model ShippingAddress {
  id          String   @id @default(uuid()) @db.Uuid
  userID      String   @map("user_id") @db.Uuid
  fullName    String   @map("full_name")
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city        String
  state       String
  postalCode  String   @map("postal_code") @db.VarChar(20)
  country     String   @db.VarChar(2) // ISO 3166-1 alpha-2
  phone       String
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      User       @relation(fields: [userID], references: [id], onDelete: Cascade)
  shipments Shipment[]

  @@index([userID])
  @@index([userID, isDefault])
  @@map("shipping_addresses")
}

model Shipment {
  id                String         @id @default(uuid()) @db.Uuid
  userID            String         @map("user_id") @db.Uuid
  inventoryItemID   String         @map("inventory_item_id") @db.Uuid
  shippingAddressID String         @map("shipping_address_id") @db.Uuid
  status            ShippingStatus @default(PENDING)
  carrier           String?        @db.VarChar(100)
  trackingNumber    String?        @unique @map("tracking_number") @db.VarChar(100)
  estimatedDelivery DateTime?      @map("estimated_delivery")
  shippedAt         DateTime?      @map("shipped_at")
  deliveredAt       DateTime?      @map("delivered_at")
  notes             String?        @db.Text
  cost              Decimal?       @db.Decimal(10, 2)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  user            User            @relation(fields: [userID], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem   @relation(fields: [inventoryItemID], references: [id], onDelete: Restrict)
  shippingAddress ShippingAddress @relation(fields: [shippingAddressID], references: [id], onDelete: Restrict)

  @@index([userID])
  @@index([inventoryItemID])
  @@index([status])
  @@index([trackingNumber])
  @@map("shipments")
}

enum MediaFileStatus {
  INITIALIZED
  UPLOADING
  COMPLETED
  FAILED
}

model MediaFile {
  id          String          @id @default(uuid()) @db.Uuid
  userID      String?         @map("user_id") @db.Uuid
  bucket      String
  key         String
  url         String?         @db.Text
  fileName    String          @map("file_name")
  contentType String          @map("content_type")
  size        BigInt?         @db.BigInt
  status      MediaFileStatus @default(INITIALIZED)
  progress    Int             @default(0)
  eTag        String?         @map("etag")
  metadata    Json?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  user User? @relation(fields: [userID], references: [id], onDelete: SetNull)

  @@index([userID])
  @@index([status])
  @@index([bucket, key])
  @@map("media_files")
}
